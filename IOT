#define BLYNK_AUTH_TOKEN "LqbhAKQfE4fDH0u-YyuVgukP9vqeSAKo"
#define BLYNK_TEMPLATE_ID "TMPL6evCguGld"
#define BLYNK_TEMPLATE_NAME "cam bien vat can"

#define BLYNK_PRINT Serial

#include <ESP8266WiFi.h>
#include <BlynkSimpleEsp8266.h>

// char auth[]= "LqbhAKQfE4fDH0u-YyuVgukP9vqeSAKo";

// char ssid[] = "QBAH";
// char pass[] =  "qbah12345";

const int trig = D2;  // chân trig của HC-SR04
const int echo = D1;  // chân echo của HC-SR04
const int led = D3;
const int buz = D4;


void setup() {
  Serial.begin(115200);
  pinMode(trig, OUTPUT);  // chân trig sẽ phát tín hiệu
  pinMode(led, OUTPUT);   
  pinMode(buz, OUTPUT);   
  pinMode(echo, INPUT);   // chân echo sẽ nhận tín hiệu

  // Blynk.begin(auth, ssid, pass);
}

void loop() {
  // Blynk.run();
  unsigned long duration;  // biến đo thời gian
  int distance;            // biến lưu khoảng cách

  /* Phát xung từ chân trig */
  digitalWrite(trig, 0);  // tắt chân trig
  delayMicroseconds(2);
  digitalWrite(trig, 1);  // phát xung từ chân trig
  delayMicroseconds(5);   // xung có độ dài 5 microSeconds
  digitalWrite(trig, 0);  // tắt chân trig

  /* Tính toán thời gian */
  // Đo độ rộng xung HIGH ở chân echo.
  duration = pulseIn(echo, HIGH);
  // Tính khoảng cách đến vật. 
  distance = int(duration / 2 / 29.412);
  if (distance <= 20) {
    digitalWrite(led, HIGH);  // bật đèn led sáng
    delay(500);              // dừng chương trình trong 1 giây => thây đèn sáng được 1 giây
    digitalWrite(led, LOW);   // tắt đèn led
    delay(500);
    Serial.print("On");

    digitalWrite(buz, HIGH);  // bật đèn led sáng
    delay(500);              // dừng chương trình trong 1 giây => thây đèn sáng được 1 giây
    digitalWrite(buz, LOW);   // tắt đèn led
    delay(500);
    Serial.print("On Buz");
    
  }
  /* In kết quả ra Serial Monitor */
  Serial.print(distance);
  Serial.println("cm");
  delay(200);
}

BLYNK_WRITE(V1)
{
  int mode = param.asInt();
  if (mode == 1){
    digitalWrite(buz, LOW);   // tắt đèn led
    delay(30000);
  }
}
